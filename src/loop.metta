!(change-state! &prevmsg "")

(= (getContext)
   (string-safe (py-str ("PROMPT: " (getPrompt) " SKILLS: " (getSkills)
                         " OUTPUT_FORMAT: Output a ((skillName1 args1) (skillName2 args2) (skillName3 args3)) S-expression of up to 3 commands,"
                         " each arg is an explicit string hence needs quotes, and variables are forbidden!"
                         " TIME: " (get_time_as_string) " MEMORY: " (getMemory) " HISTORY: " (getHistory)))))

(= (mettaclaw) 
   (mettaclaw 1))
(= (mettaclaw $k)
   (progn (if (== $k 1) (progn (initMemory) 
                               (initChannels)) _)
          (let $prompt (getContext)
               (progn (println! (---------iteration $k))
                      (let* (($msg (string-safe (repr (receive))))
                             ($lastmessage (HUMAN-LAST-MSG: $msg
                                            MESSAGE-IS-NEW: (!= $msg (get-state &prevmsg))))
                             ($_ (println! $lastmessage))
                             ($_ (change-state! &prevmsg $msg))
                             ($send (py-str ($prompt $lastmessage)))
                             ($_ (println! (CHARS_SENT: (string_length $send) $send)))
                             ($response (useGPT $send))
                             ($sexpr (catch (sread $response)))
                             ($_ (println! (RESPONSE: $sexpr)))
                             ($results (RESULTS: (collapse (for $s $sexpr (COMMAND_RETURN: ($s (eval $s)))))))
                             ($_ (println! $results)))
                            (addToHistory $lastmessage $response $sexpr $results))
                      (sleep 1)
                      (mettaclaw (+ 1 $k))))))
